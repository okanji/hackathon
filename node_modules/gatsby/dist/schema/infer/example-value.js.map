{"version":3,"sources":["../../../src/schema/infer/example-value.js"],"names":["_","require","is32BitInteger","isDate","getExampleValue","nodes","typeName","typeConflictReporter","ignoreFields","exampleValue","getExampleObject","prefix","module","exports","rawNodes","filter","node","allKeys","reduce","acc","Object","keys","forEach","key","includes","add","Set","Array","from","entries","map","value","type","getType","parent","Boolean","selector","entriesByType","uniqBy","entry","length","arrayWrappers","isArray","isMixOfDatesAndStrings","allNonEmptyStringsAreDates","every","values","flatMap","addConflict","exampleFieldValue","isObject","isRegExp","objects","arrays","concat","exampleObject","findFloat","types","startsWith","slice","split","t","replace","size","has","result","find","numbers","some","number","Date","String","uniqueValues","uniq","v","join"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst is32BitInteger = require(`./is-32-bit-integer`)\nconst { isDate } = require(`../types/date`)\n\nconst getExampleValue = ({\n  nodes,\n  typeName,\n  typeConflictReporter,\n  ignoreFields,\n}) => {\n  const exampleValue = getExampleObject({\n    nodes,\n    prefix: typeName,\n    typeConflictReporter,\n    ignoreFields,\n  })\n  return exampleValue\n}\n\nmodule.exports = {\n  getExampleValue,\n}\n\nconst getExampleObject = ({\n  nodes: rawNodes,\n  prefix,\n  typeConflictReporter,\n  ignoreFields = [],\n}) => {\n  const nodes = rawNodes.filter(node => node != null)\n  const allKeys = nodes.reduce(\n    (acc, node) =>\n      Object.keys(node).forEach(\n        key => key && !ignoreFields.includes(key) && acc.add(key)\n      ) || acc,\n    new Set()\n  )\n\n  const exampleValue = Array.from(allKeys).reduce((acc, key) => {\n    const entries = nodes\n      .map(node => {\n        const value = node[key]\n        const type = getType(value)\n        return type && { value, type, parent: node }\n      })\n      .filter(Boolean)\n\n    const selector = prefix ? `${prefix}.${key}` : key\n\n    const entriesByType = _.uniqBy(entries, entry => entry.type)\n    if (!entriesByType.length) return acc\n\n    // TODO: This whole thing could be prettier!\n    let { value, type } = entriesByType[0]\n    let arrayWrappers = 0\n    while (Array.isArray(value)) {\n      value = value[0]\n      arrayWrappers++\n    }\n\n    if (entriesByType.length > 1 || type.includes(`,`)) {\n      if (\n        isMixOfDatesAndStrings(\n          entriesByType.map(entry => entry.type),\n          arrayWrappers\n        )\n      ) {\n        // TODO: Possibly revisit this in Gatsby v3.\n        const allNonEmptyStringsAreDates = entries.every(entry => {\n          const values = Array.isArray(entry.value)\n            ? _.flatMap(entry.value)\n            : [entry.value]\n          return values.every(\n            value => value === `` || getType(value) === `date`\n          )\n        })\n        if (allNonEmptyStringsAreDates) {\n          value = `1978-09-26`\n        } else {\n          value = `String`\n        }\n      } else {\n        typeConflictReporter.addConflict(selector, entriesByType)\n        return acc\n      }\n    }\n\n    let exampleFieldValue\n    if (\n      _.isObject(value) &&\n      !_.isArray(value) &&\n      !_.isDate(value) &&\n      !_.isRegExp(value)\n    ) {\n      const objects = entries.reduce((acc, entry) => {\n        let { value } = entry\n        let arrays = arrayWrappers - 1\n        while (arrays > 0) {\n          value = value[0]\n          arrays--\n        }\n        return acc.concat(value)\n      }, [])\n      const exampleObject = getExampleObject({\n        nodes: objects,\n        prefix: selector,\n        typeConflictReporter,\n      })\n      if (!Object.keys(exampleObject).length) return acc\n      exampleFieldValue = exampleObject\n    } else if (key.includes(`___NODE`) && arrayWrappers) {\n      // For arrays on ___NODE foreign-key fields we return all values,\n      // because the array values are allowed to link to nodes of different types.\n      // For those we will create a GraphQLUnionType later.\n      arrayWrappers--\n      exampleFieldValue = entries.reduce(\n        (acc, entry) => acc.concat(entry.value),\n        []\n      )\n    } else {\n      // FIXME: Why not simply treat every number as float (instead of looping through all values again)?\n      exampleFieldValue =\n        (typeof value === `number` && findFloat(entries)) || value\n      // exampleFieldValue = value === `number` ? 0.1 : value\n    }\n    while (arrayWrappers--) {\n      exampleFieldValue = [exampleFieldValue]\n    }\n    acc[key] = exampleFieldValue\n\n    return acc\n  }, {})\n\n  return exampleValue\n}\n\nconst isMixOfDatesAndStrings = (types, arrayWrappers) => {\n  const acc = new Set()\n  types.every(type => {\n    let arrays = arrayWrappers\n    while (arrays--) {\n      if (type.startsWith(`[`)) {\n        type = type.slice(1, -1)\n      } else {\n        return false\n      }\n    }\n    type.split(`,`).forEach(t => acc.add(t.replace(/[[]]/g, ``)))\n    return true\n  })\n  return acc.size === 2 && acc.has(`date`) && acc.has(`string`)\n}\n\nconst findFloat = entries => {\n  let result\n  const find = numbers =>\n    numbers.some(value => {\n      const number = typeof value === `object` ? value.value : value\n      return Array.isArray(number)\n        ? find(number)\n        : !is32BitInteger(number) && (result = number)\n    })\n  find(entries)\n  return result\n}\n\nconst getType = value => {\n  switch (typeof value) {\n    case `number`:\n      return `number`\n    case `string`:\n      return isDate(value) ? `date` : `string`\n    case `boolean`:\n      return `boolean`\n    case `object`:\n      if (value === null) return null\n      if (value instanceof Date) return `date`\n      if (value instanceof String) return `string`\n      if (Array.isArray(value)) {\n        const uniqueValues = _.uniq(value.map(getType).filter(v => v != null))\n        return uniqueValues.length ? `[${uniqueValues.join(`,`)}]` : null\n      }\n      if (!Object.keys(value).length) return null\n      return `object`\n    default:\n      return null\n  }\n}\n"],"file":"example-value.js"}